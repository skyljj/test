- name: Print Tower execution context
  debug:
    msg:
      - "Tower user name: {{ tower_user_name | default('unknown') }}"
      - "Tower user id: {{ tower_user_id | default('unknown') }}"
      - "Job id: {{ tower_job_id | default('unknown') }}"
      - "Job template id: {{ tower_job_template_id | default('unknown') }}"


- name: Configure chrony
  k8s:
    state: present
    definition:
      apiVersion: config.openshift.io/v1
      kind: ChronyConfig
      metadata:
        name: cluster
      spec:
        servers:
          - {{ my_chrony_server }}


- name: Normalize ESXi services to dict
  set_fact:
    esxi_services: >-
      {{
        dict(
          host_services.host_service_info[inventory_hostname]
          | map(attribute='key')
          | zip(host_services.host_service_info[inventory_hostname])
        )
      }}


- name: Service policy compliance check
  set_fact:
    Compliant: false
  loop: "{{ service | dict2items }}"
  when:
    - item.key not in esxi_services
      or
      esxi_services[item.key].policy != item.value.policy
      or
      esxi_services[item.key].running != item.value.running

- name: Collect non-compliant services
  set_fact:
    non_compliant_services: "{{ non_compliant_services | default([]) + [ item.key ] }}"
  loop: "{{ service | dict2items }}"
  when:
    - item.key not in esxi_services
      or
      esxi_services[item.key].policy != item.value.policy
      or
      esxi_services[item.key].running != item.value.running
