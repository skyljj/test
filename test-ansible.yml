- name: Print Tower execution context
  debug:
    msg:
      - "Tower user name: {{ tower_user_name | default('unknown') }}"
      - "Tower user id: {{ tower_user_id | default('unknown') }}"
      - "Job id: {{ tower_job_id | default('unknown') }}"
      - "Job template id: {{ tower_job_template_id | default('unknown') }}"


- name: Configure chrony
  k8s:
    state: present
    definition:
      apiVersion: config.openshift.io/v1
      kind: ChronyConfig
      metadata:
        name: cluster
      spec:
        servers:
          - {{ my_chrony_server }}


- name: Normalize ESXi services to dict
  set_fact:
    esxi_services: >-
      {{
        dict(
          host_services.host_service_info[inventory_hostname]
          | map(attribute='key')
          | zip(host_services.host_service_info[inventory_hostname])
        )
      }}


- name: Service policy compliance check
  set_fact:
    Compliant: false
  loop: "{{ service | dict2items }}"
  when:
    - item.key not in esxi_services
      or
      esxi_services[item.key].policy != item.value.policy
      or
      esxi_services[item.key].running != item.value.running

- name: Collect non-compliant services
  set_fact:
    non_compliant_services: "{{ non_compliant_services | default([]) + [ item.key ] }}"
  loop: "{{ service | dict2items }}"
  when:
    - item.key not in esxi_services
      or
      esxi_services[item.key].policy != item.value.policy
      or
      esxi_services[item.key].running != item.value.running



- name: Print NIC details
  debug:
    msg:
      label: "{{ vm_info.instance['hw_' ~ item].label }}"
      mac: "{{ vm_info.instance['hw_' ~ item].macaddress }}"
      portgroup: "{{ vm_info.instance['hw_' ~ item].portgroup_key }}"
  loop: "{{ vm_info.instance.hw_interfaces }}"

- name: Collect NIC definitions
  set_fact:
    nic_definitions: >-
      {{
        nic_definitions | default([]) + [
          {
            'label': vm_info.instance['hw_' ~ item].label,
            'mac': vm_info.instance['hw_' ~ item].macaddress,
            'portgroup': vm_info.instance['hw_' ~ item].portgroup_key
          }
        ]
      }}
  loop: "{{ vm_info.instance.hw_interfaces }}"

- name: Fail if Network adapter 1 already exists
  fail:
    msg: "Unexpected Network adapter 1 found before PXE reprovision"
  when: >
    nic_definitions
    | selectattr('label', 'equalto', 'Network adapter 1')
    | list
    | length > 0
    


- name: Re-add original NICs with same MAC
  community.vmware.vmware_guest_network:
    hostname: "{{ vcenter_hostname }}"
    username: "{{ vcenter_username }}"
    password: "{{ vcenter_password }}"
    validate_certs: false
    datacenter: "{{ datacenter }}"
    name: "{{ vm_name }}"
    state: present
    network_name: "{{ item.network }}"
    mac_address: "{{ item.mac }}"
    device_type: "{{ item.type }}"
    connected: "{{ item.connected | default(true) }}"
    start_connected: "{{ item.start_connected | default(true) }}"
  loop: "{{ nic_definitions }}"


- name: Restore normal boot order
  vmware_guest:
    ...
    boot_order:
      - disk
      - network
